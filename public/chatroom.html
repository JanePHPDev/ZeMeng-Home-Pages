<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>梦泽聊天室</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.mengze.vip/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.mengze.vip/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
  <style>
    :root {
      --primary: #2ecc71;
      --secondary: #3498db;
      --success: #27ae60;
      --warning: #f1c40f;
      --danger: #e74c3c;
    }

    .chat-container {
      transition: all 0.3s ease;
      height: 80vh;
    }

    .chat-container.fullscreen {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      z-index: 1050;
      margin: 0 !important;
      height: 100vh !important;
      border-radius: 0 !important;
    }

    .message {
      max-width: 85%;
      border-radius: 1rem !important;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .message.me {
      background: linear-gradient(135deg, var(--primary), var(--success)) !important;
      border-bottom-right-radius: 0.25rem !important;
    }

    .message:not(.me) {
      background: #f8f9fa;
      border-bottom-left-radius: 0.25rem !important;
    }

    .user-avatar-img {
      width: 40px;
      height: 40px;
      object-fit: cover;
    }

    #chatMessages {
      scrollbar-width: thin;
      scrollbar-color: var(--primary) rgba(0,0,0,0.1);
    }

    #chatMessages::-webkit-scrollbar {
      width: 8px;
    }

    #chatMessages::-webkit-scrollbar-thumb {
      background-color: var(--primary);
      border-radius: 4px;
    }
  </style>
</head>
<body class="bg-light">
  <!-- 加载提示 -->
  <div class="position-fixed top-0 end-0 m-3 alert alert-primary d-none" id="loading">
    <span class="spinner-border spinner-border-sm"></span>
    连接中...
  </div>

  <!-- 用户信息模态框 -->
  <div class="modal fade" id="userModal" data-bs-backdrop="static">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">用户设置</h5>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">用户名</label>
            <input type="text" class="form-control" id="userName" required autofocus>
          </div>
          <div class="mb-3">
            <label class="form-label">QQ号（可选）</label>
            <input type="number" class="form-control" id="userQQ">
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" onclick="saveUserInfo()">进入聊天室</button>
        </div>
      </div>
    </div>
  </div>

  <div class="container py-3">
    <div class="row g-3">
      <!-- 主聊天区 -->
      <div class="col-lg-8">
        <div class="chat-container card h-100 shadow-sm">
          <div class="card-header d-flex justify-content-between align-items-center bg-white">
            <h5 class="m-0 text-primary">
              <i class="bi bi-chat-dots me-2"></i>梦泽聊天室
            </h5>
            <button class="btn btn-sm btn-outline-secondary" onclick="toggleFullscreen()">
              <i class="bi bi-arrows-fullscreen"></i>
            </button>
          </div>
          
          <div class="card-body p-0">
            <div class="chat-messages p-3" id="chatMessages" style="height: calc(100% - 120px); overflow-y: auto"></div>
            
            <div class="card-footer bg-white border-top">
              <div class="input-group">
                <input type="text" class="form-control" id="messageInput" 
                      placeholder="输入消息..." 
                      autocomplete="off"
                      onkeypress="if(event.keyCode === 13) sendMessage()">
                <button class="btn btn-success" onclick="sendMessage()">
                  <i class="bi bi-send"></i>
                </button>
              </div>
              <div class="mt-2 text-muted small">
                <span class="me-3"><i class="bi bi-people"></i> <span id="userCount">0</span></span>
                <span><i class="bi bi-chat"></i> <span id="messageCount">0</span></span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 侧边栏 -->
      <div class="col-lg-4">
        <div class="row g-3">
          <!-- 在线用户 -->
          <div class="col-12">
            <div class="card shadow-sm">
              <div class="card-header bg-white">
                <h5 class="m-0"><i class="bi bi-person-circle me-2"></i>在线用户</h5>
              </div>
              <div class="card-body p-2" style="height: 300px; overflow-y: auto">
                <div class="user-list list-group list-group-flush" id="userList"></div>
              </div>
            </div>
          </div>

          <!-- 系统公告 -->
          <div class="col-12">
            <div class="card shadow-sm">
              <div class="card-header bg-white">
                <h5 class="m-0"><i class="bi bi-megaphone me-2"></i>系统公告</h5>
              </div>
              <div class="card-body small">
                <ul class="list-unstyled mb-0">
                  <li class="mb-2"><i class="bi bi-server me-2"></i>服务器由@3888165101 赞助</li>
                  <li class="mb-2 text-danger"><i class="bi bi-exclamation-triangle me-2"></i>请文明聊天</li>
                  <li class="mb-2"><i class="bi bi-save me-2"></i>保存最近50条消息</li>
                  <li><i class="bi bi-people me-2"></i>技术支持QQ群：940994905</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap 5 JS -->
  <script src="https://cdn.mengze.vip/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const loading = document.getElementById('loading');
    const chatMessages = document.getElementById('chatMessages');
    const messageInput = document.getElementById('messageInput');
    const userList = document.getElementById('userList');
    const userCounts = document.querySelectorAll('#userCount');
    const messageCount = document.getElementById('messageCount');

    let ws;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    let currentUser = { name: '', qq: '' };

    // 全屏切换
    function toggleFullscreen() {
      const container = document.querySelector('.chat-container');
      container.classList.toggle('fullscreen');
      
      const fullscreenBtn = document.querySelector('[onclick="toggleFullscreen()"]');
      fullscreenBtn.innerHTML = container.classList.contains('fullscreen') 
        ? '<i class="bi bi-fullscreen-exit"></i>' 
        : '<i class="bi bi-arrows-fullscreen"></i>';
    }

    // Cookie操作
    function setCookie(name, value, days) {
      const d = new Date();
      d.setTime(d.getTime() + (days*24*60*60*1000));
      document.cookie = `${name}=${encodeURIComponent(value)};expires=${d.toUTCString()};path=/`;
    }

    function getCookie(name) {
      return document.cookie.split('; ').reduce((r, v) => {
        const parts = v.split('=');
        return parts[0] === name ? decodeURIComponent(parts[1]) : r
      }, '');
    }

    // 初始化
    window.onload = function() {
      const savedUser = getCookie('chatUser');
      const userModal = new bootstrap.Modal('#userModal');

      if (savedUser) {
        try {
          currentUser = JSON.parse(savedUser);
          connect();
        } catch {
          userModal.show();
        }
      } else {
        userModal.show();
      }
    };

    // 保存用户信息
    function saveUserInfo() {
      const name = document.getElementById('userName').value.trim();
      if (!name) return alert('用户名不能为空');

      currentUser = {
        name: name,
        qq: document.getElementById('userQQ').value.trim()
      };

      setCookie('chatUser', JSON.stringify(currentUser), 30);
      bootstrap.Modal.getInstance('#userModal').hide();
      connect();
    }

    // WebSocket连接
    function connect() {
      loading.classList.remove('d-none');
      ws = new WebSocket('wss://wss.mzurl.xyz:35005');

      ws.onopen = () => {
        loading.classList.add('d-none');
        ws.send(JSON.stringify({ type: 'join', data: currentUser }));
      };

      ws.onmessage = handleMessage;

      ws.onclose = () => {
        if (reconnectAttempts < maxReconnectAttempts) {
          setTimeout(connect, Math.min(1000 * reconnectAttempts, 5000));
          reconnectAttempts++;
          loading.innerHTML = `
            <span class="spinner-border spinner-border-sm"></span>
            重连中 (${reconnectAttempts}/${maxReconnectAttempts})...
          `;
        }
      };
    }

    // 消息处理
    function handleMessage(e) {
      try {
        const msg = JSON.parse(e.data);
        const handlers = {
          history: data => data.messages.forEach(appendMessage),
          message: data => {
            appendMessage(data);
            messageCount.textContent = parseInt(messageCount.textContent) + 1;
            chatMessages.scrollTop = chatMessages.scrollHeight;
          },
          userlist: data => {
            userList.innerHTML = data.users.map(user => `
              <li class="list-group-item d-flex align-items-center">
                <img src="${user.avatar || '//q1.qlogo.cn/g?b=qq&nk=${user.qq}&s=100'}" 
                     class="user-avatar-img rounded-circle me-2">
                <span>${user.name}${user.name === currentUser.name ? ' <small>(我)</small>' : ''}</span>
              </li>
            `).join('');
            userCounts.forEach(el => el.textContent = data.users.length);
          }
        };
        if (handlers[msg.type]) handlers[msg.type](msg.data);
      } catch (error) {
        console.error('消息解析错误:', error);
      }
    }

    // 添加消息
    function appendMessage(msg) {
      const isMe = msg.user === currentUser.name;
      const time = new Date(msg.timestamp).toLocaleTimeString();
      
      const messageEl = document.createElement('div');
      messageEl.className = `alert ${isMe ? 'alert-success me' : 'alert-light'} message`;
      messageEl.innerHTML = `
        <div class="d-flex justify-content-between small mb-2">
          <span>${escapeHtml(msg.user)}</span>
          <span>${time}</span>
        </div>
        <div class="message-content">${escapeHtml(msg.content)}</div>
      `;
      chatMessages.appendChild(messageEl);
    }

    // 发送消息
    function sendMessage() {
      const content = messageInput.value.trim();
      if (content && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'message', data: { content }}));
        messageInput.value = '';
        messageInput.focus();
      }
    }

    // 安全转义
    function escapeHtml(unsafe) {
      return unsafe.toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
  </script>
</body>
</html>